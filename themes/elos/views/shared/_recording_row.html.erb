<%# Params passed to render partial %>
<% [user, room, meeting, recording] %>

<tr class="recording-row d-flex row tr-row rec-<%= recording[:internalMeetingID].present? %>">
  <%# Meeting name and description %>
  <td class="col-md-5 td-titles" data-search-field="1">
    <div class="item-title">
      <%= meeting[:meetingName] ? meeting[:meetingName] : recording[:metadata][:name] %>
    </div>
    <div class="item-description" data-search-field="1">
      <div id='recording-description-text' class="text-wrap">
        <%= recording[:metadata][:'bbb-recording-description'] ? recording[:metadata][:'bbb-recording-description'] : nil %>
      </div>
    </div>
  </td>

  <%# Meeting creation date %>
  <td class="col-md-1">
    <%= format_date(meeting[:startTime].to_i, :day_month_year, false) %>
  </td>

  <%# Meeting creation time %>
  <td class="col-md-1">
    <%= format_time(meeting[:startTime].to_i) %>
  </td>

  <%# Meeting duration %>
  <td class="col-md-2">
    <% duration = meeting[:endTime].to_i/1000 - meeting[:startTime].to_i/1000 %>
    <% if duration/60 > 0 %>
      <%= duration_in_hours_and_minutes(duration).capitalize %>
    <% else %>
      <%= t("recordings.duration.less_than_a_minute") %>
    <% end %>
  </td>

  <%# Meeting with recording %>
  <% if recording[:internalMeetingID].present? %>
    <%# Recording visibility %>
    <td class="col-md-1">
      <% if recording[:published] %>
        <%= icon_visibility(title: t("recordings.published"), class: 'color-secondary fa-2x') %>
      <% else %>
        <%= icon_visibility_off(title: t("recordings.unpublished"), class: 'color-gray-04 fa-2x') %>
      <% end %>
    </td>

    <%# Recording state/action icons %>
    <td class="col-md-1 flex-row-reverse">
      <% if recording[:state] != 'processing' %>
        <% if recording[:published] %>
          <% if can_download_recording?(user, room)%>
            <% recording[:playbacks].each do |p| %>
              <% url = playback_url(room, recording[:recordID], p) %>
              <% if p[:type] == 'presentation' %>
                <%= link_to icon_conference_play(title: t("recordings.playbacks.#{p[:type]}"), class: 'fa-2x'), url, class: 'd-flex text-decoration-none ml-2', target: "_blank" %>
              <% else %>
                <%= link_to icon_file_download(title: t("recordings.playbacks.#{p[:type]}"), class: 'fa-2x'), url, class: 'd-flex text-decoration-none', target: "_blank" %>
              <% end %>
            <% end %>
          <% else %>
            <% url = playback_url(room, recording[:recordID], recording[:playbacks].find { |p| p[:type] == 'presentation' }) %>
            <%= link_to icon_conference_play(title: t("recordings.playbacks.presentation"), class: 'fa-2x'), url, class: 'd-flex text-decoration-none', target: "_blank" %>
          <% end %>
        <% end %>
      <% else %>
        <%= icon_recording_load(title: t("recordings.processing"), class: 'color-primary fa-2x') %>
      <% end %>
    </td>

    <%# Options dropdown %>
    <% if recording[:state] != 'processing' %>
      <td class="col-md-1 td-dropdown-opts">
        <div class="dropdown dropdown-opts">
          <a href="#" class="dropdown-toggle d-flex text-decoration-none" id="dropdown-opts-<%= recording[:recordID] %>" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <%= icon_options_dots %>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdown-opts-<%= recording[:recordID] %>">

            <%# Copy playback link %>
            <% if recording[:published] %>
              <% playback = recording[:playbacks].find { |p| p[:type] == 'presentation' } %>
              <% if playback.present? %>
                <%=
                link_to t('recordings.playback_link'), '#',
                data: {
                  'clipboard-text': playback_url(room, recording[:recordID], playback),
                  turbolinks: false,
                  'toast-id': '#playback-link-copied-toast'
                },
                class: "dropdown-item copy-to-clipboard"
                %>
              <% end %>
            <% end %>

            <% if can_edit?(user, room) %>
              <%# Unpublish recording %>
              <% if recording[:published] %>
                <div class="dropdown-divider"></div>
                <%= link_to recording_unpublish_path(room, record_id: recording[:recordID]),
                method: :post,
                data: { confirm: t('recordings.confirm.unpublish') },
                class: "dropdown-item" do %>
                  <%= t("recordings.unpublish") %>
                <% end %>
              <%# Publish recording %>
              <% else %>
                <%= link_to recording_publish_path(room, record_id: recording[:recordID]),
                method: :post,
                data: { confirm: t('recordings.confirm.publish') },
                class: "dropdown-item" do %>
                  <%= t("recordings.publish") %>
                <% end %>
              <% end %>
              <%# Delete recording %>
              <%= link_to recording_delete_path(room, record_id: recording[:recordID]),
              method: :post,
              data: { confirm: t('recordings.confirm.destroy') },
              class: "dropdown-item" do %>
                <%= t("recordings.destroy") %>
              <% end %>
            <% end %>

          </div>
        </div>
      </td>
    <% end %>

  <%# Meeting without recording, leave the last 3 columns empty %>
  <% else %>
    <td class="col-md-1 align-middle"></td>
    <td class="col-md-1 align-middle"></td>
    <td class="col-md-1 align-middle td-dropdown-opts"></td>
  <% end %>
</tr>